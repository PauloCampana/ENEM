[
  {
    "objectID": "chapters/1-limpeza.html",
    "href": "chapters/1-limpeza.html",
    "title": "\n1  Limpeza de dados\n",
    "section": "",
    "text": "library(tidyverse)\n\n\nmicrodados <- \"../dados/microdados.csv\" |>\n    vroom::vroom(\n        locale = locale(encoding = \"ISO-8859-1\"),\n        show_col_types = FALSE\n    ) |> \n    select(\n        inscrição      = NU_INSCRICAO,\n        região         = CO_MUNICIPIO_PROVA, \n        estado         = SG_UF_PROVA, \n        município      = NO_MUNICIPIO_PROVA,\n        idade          = TP_FAIXA_ETARIA,\n        sexo           = TP_SEXO, \n        estado_civil   = TP_ESTADO_CIVIL,\n        cor            = TP_COR_RACA,\n        nacionalidade  = TP_NACIONALIDADE,\n        situação_médio = TP_ST_CONCLUSAO,\n        renda          = Q006, \n        internet       = Q025,\n        MT             = NU_NOTA_MT, \n        CN             = NU_NOTA_CN, \n        CH             = NU_NOTA_CH, \n        LC             = NU_NOTA_LC,\n        R              = NU_NOTA_REDACAO, \n        R1             = NU_NOTA_COMP1,\n        R2             = NU_NOTA_COMP2,\n        R3             = NU_NOTA_COMP3, \n        R4             = NU_NOTA_COMP4, \n        R5             = NU_NOTA_COMP5\n    ) |> \n    filter(if_all(\n        c(internet, renda, MT:R),\n        function(x) !is.na(x) & x != 0\n    )) |> \n    mutate(\n        região = (região %/% 1e6) |> case_match(\n            1 ~ \"Norte\",\n            2 ~ \"Nordeste\",\n            3 ~ \"Sudeste\",\n            4 ~ \"Sul\",\n            5 ~ \"Centro-Oeste\"\n        ) |> as.factor(),\n        estado = estado |> case_match(\n            \"RO\" ~ \"Rondônia\",\n            \"AC\" ~ \"Acre\",   \n            \"AM\" ~ \"Amazonas\",\n            \"RR\" ~ \"Roraima\",\n            \"PA\" ~ \"Pará\",\n            \"AP\" ~ \"Amapá\",\n            \"TO\" ~ \"Tocantins\",\n            \"MA\" ~ \"Maranhão\",\n            \"PI\" ~ \"Piauí\",     \n            \"CE\" ~ \"Ceará\",\n            \"RN\" ~ \"Rio Grande do Norte\",\n            \"PB\" ~ \"Paraíba\", \n            \"PE\" ~ \"Pernambuco\",\n            \"AL\" ~ \"Alagoas\", \n            \"SE\" ~ \"Sergipe\",\n            \"BA\" ~ \"Bahia\",\n            \"MG\" ~ \"Minas Gerais\",\n            \"ES\" ~ \"Espírito Santo\",  \n            \"RJ\" ~ \"Rio de Janeiro\",\n            \"SP\" ~ \"São Paulo\",\n            \"PR\" ~ \"Paraná\",         \n            \"SC\" ~ \"Santa Catarina\",\n            \"RS\" ~ \"Rio Grande do Sul\",\n            \"MS\" ~ \"Mato Grosso do Sul\",\n            \"MT\" ~ \"Mato Grosso\",     \n            \"GO\" ~ \"Goiás\",\n            \"DF\" ~ \"Distrito Federal\",\n        ) |> as.factor(),\n        idade = idade |> case_match(\n            1  ~ \"0-17\", \n            2  ~ \"17\",\n            3  ~ \"18\",  \n            4  ~ \"19\",\n            5  ~ \"20\",  \n            6  ~ \"21\",   \n            7  ~ \"22\",  \n            8  ~ \"23\",\n            9  ~ \"24\",  \n            10 ~ \"25\", \n            11 ~ \"26-30\", \n            12 ~ \"31-35\",\n            13 ~ \"36-40\", \n            14 ~ \"41-45\", \n            15 ~ \"46-50\", \n            16 ~ \"51-55\",\n            17 ~ \"56-60\",\n            18 ~ \"61-65\", \n            19 ~ \"66-70\", \n            20 ~ \"70+\"\n        ) |> as.ordered(),\n        sexo = sexo |> case_match(\n            \"F\" ~ \"Feminino\",\n            \"M\" ~ \"Masculino\" \n        ) |> as.factor(),\n        estado_civil = estado_civil |> case_match(\n            0 ~ NA,\n            1 ~ \"Solteiro\",\n            2 ~ \"Casado\",\n            3 ~ \"Divorciado\",\n            4 ~ \"Viúvo\"\n        ) |> as.factor(),\n        cor = cor |> case_match(\n            0 ~ NA, \n            1 ~ \"Branca\",\n            2 ~ \"Preta\",\n            3 ~ \"Parda\",\n            4 ~ \"Amarela\",\n            5 ~ \"Indígena\",\n            6 ~ NA\n        ) |> as.factor(),\n        nacionalidade = nacionalidade |> case_match(\n            0 ~ NA,\n            1 ~ \"Brasileiro\",\n            2 ~ \"Brasileiro naturalizado\",\n            3 ~ \"Estrangeiro\",\n            4 ~ \"Brasileiro nascido no exterior\" \n        ) |> as.factor(),\n        situação_médio = situação_médio |> case_match(\n            1 ~ \"Concluído\", \n            2 ~ \"Será concluído em 2021\",\n            3 ~ \"Será concluído após 2021\",  \n            4 ~ \"Não concluíu\"\n        ) |> as.factor(),\n        renda = renda |> recode_factor(\n            \"A\" = \"0\",           \n            \"B\" = \"0-1100\",     \n            \"C\" = \"1100-1650\",\n            \"D\" = \"1650-2200\",   \n            \"E\" = \"2200-2750\",   \n            \"F\" = \"2750-3300\",\n            \"G\" = \"3300-4400\",  \n            \"H\" = \"4400-5500\", \n            \"I\" = \"5500-6600\",\n            \"J\" = \"6600-7700\",   \n            \"K\" = \"7700-8800\",   \n            \"L\" = \"8800-9900\",\n            \"M\" = \"9900-11000\",  \n            \"N\" = \"11000-13200\", \n            \"O\" = \"13200-16500\",\n            \"P\" = \"16500-22000\",\n            \"Q\" = \"22000+\",\n            .ordered = TRUE\n        ),\n        internet = internet |> case_match(\n            \"A\" ~ \"Não\",\n            \"B\" ~ \"Sim\" \n        ) |> as.factor()\n    )\n\n\nmicrodados |>  \n    arrow::write_dataset(\n        path = \"../dados\",\n        format = \"parquet\",\n        basename_template = \"microdados{i}.parquet\"\n    )"
  },
  {
    "objectID": "chapters/2-análise-exploratória.html",
    "href": "chapters/2-análise-exploratória.html",
    "title": "\n2  Análise exploratória\n",
    "section": "",
    "text": "library(tidyverse)\nlibrary(reactablefmtr)\nsource(\"../misc/themes.R\")\n\n\nmicrodados <- \"../dados/microdados0.parquet\" |>\n    arrow::read_parquet()\n\n\nmicrodados_tabela <- microdados |>\n    select(região, estado, MT:R) |>\n    summarise(\n        across(MT:R, function(x) round(mean(x))),\n        .by = c(região, estado)\n    ) \n\nmicrodados_mapa <- \"../dados/mapa/estados.shp\" |>\n    sf::read_sf() |> \n    sf::st_simplify(preserveTopology = TRUE, dTolerance = 100)\n\nmicrodados_mapa_pivot <- microdados_mapa |> \n    left_join(\n        microdados |> \n            summarise(across(MT:R, mean), .by = estado) |> \n            pivot_longer(MT:R, names_to = \"área\", values_to = \"notas\"),\n        join_by(nome == estado)\n    ) \n\nmicrodados_mapa_notas <- microdados_mapa |> \n    left_join(\n        microdados |> \n            summarise(notas = mean(c(MT, CN, CH, LC, R)), .by = estado),\n        join_by(nome == estado)\n    ) \n\nmicrodados_pivot <- microdados |> \n    select(sexo, internet, MT:R) |> \n    pivot_longer(MT:R, names_to = \"área\", values_to = \"notas\")\n\nmicrodados_notas <- microdados |> \n    select(idade, renda, MT:R) |> \n    mutate(notas = (MT + CN + CH + LC + R) / 5, .keep = \"unused\")\n\n\ncol_def_data_bars <- function(column, color) {\n    colDef(\n        cell = data_bars(\n            data = microdados_tabela,\n            text_position = \"above\", text_color = \"#ffffff\",\n            background = \"#282c34\", fill_color = color,\n            min_value = min(microdados_tabela[column]) - 10,\n    ))\n}\n\n\nmicrodados_tabela |> \n    reactable(\n        pagination = FALSE, compact = TRUE, \n        bordered = TRUE, highlight = TRUE, \n        showSortable = TRUE,\n        defaultSortOrder = \"desc\", defaultSorted = \"MT\",\n        theme = theme_darkly_table,\n        defaultColDef = colDef(align = \"left\"),\n        columns = list(\n            \"região\" = colDef(name = \"Região\"),\n            \"estado\" = colDef(name = \"Estado\", width = 180),\n            \"MT\" = col_def_data_bars(\"MT\", \"#80c0f0\"),\n            \"CN\" = col_def_data_bars(\"CN\", \"#a0f0a0\"),\n            \"CH\" = col_def_data_bars(\"CH\", \"#f0c080\"),\n            \"LC\" = col_def_data_bars(\"LC\", \"#f080c0\"),\n            \"R\"  = col_def_data_bars(\"R\",  \"#f0a0a0\")\n        )\n    )\n\n\n\n\n\n\n\nmicrodados_mapa_pivot |> \n    ggplot(aes(fill = notas)) +\n    geom_sf(color = \"#000000\", linewidth = 0.1) +\n    coord_sf(expand = FALSE) +\n    facet_grid(cols = vars(área)) +\n    scale_fill_viridis_c(\n        name = \"Notas\",\n        guide = guide_colorbar(ticks = FALSE)\n    ) +\n    theme_darkly +\n    theme_map\n\n\n\n\n\nmicrodados_mapa_notas |> \n    ggplot(aes(fill = notas)) +\n    geom_sf(color = \"#000000\", linewidth = 0.2) +\n    coord_sf(expand = FALSE) +\n    scale_fill_viridis_c(\n        name = \"Notas\",\n        guide = guide_colorbar(ticks = FALSE)\n    ) +\n    theme_darkly +\n    theme_map\n\n\n\n\n\nmicrodados_pivot |> \n    ggplot(aes(x = notas, fill = sexo, color = sexo)) +\n    geom_density(alpha = 1/3) +\n    facet_grid(rows = vars(área), switch = \"y\", scales = \"free\") +\n    scale_color_manual(\n        name = \"Sexo\",\n        values = c(\"#ff4080\", \"#4080ff\"),\n        aesthetics = c(\"fill\", \"color\")\n    ) +\n    scale_x_continuous(\n        name = \"Notas\",\n        breaks = seq(0, 1000, by = 100)\n    ) +\n    theme_darkly +\n    theme_density\n\n\n\n\n\nmicrodados_pivot |> \n    ggplot(aes(x = notas, fill = internet, color = internet)) +\n    geom_density(alpha = 1/3) +\n    facet_grid(rows = vars(área), switch = \"y\", scales = \"free\") +\n    scale_color_manual(\n        name = \"Internet\",\n        values = c(\"#ff8080\", \"#80ff80\"),\n        aesthetics = c(\"fill\", \"color\")\n    ) +\n    scale_x_continuous(\n        name = \"Notas\",\n        breaks = seq(0, 1000, by = 100)\n    ) +\n    theme_darkly +\n    theme_density\n\n\n\n\n\nmicrodados_notas |>\n    ggplot(aes(x = notas, y = idade, color = idade)) +\n    ggridges::geom_density_ridges(scale = 4, alpha = 0) + \n    scale_color_viridis_d(option = \"F\", begin = 0.3) +\n    lims(x = c(300, 850)) +\n    labs(x = \"Notas\", y = \"Idade\") +\n    theme_darkly +\n    theme_ridges\n\n\n\n\n\nmicrodados_notas |>\n    ggplot(aes(x = notas, y = renda, color = renda)) +\n    ggridges::geom_density_ridges(scale = 4, alpha = 0) +\n    scale_color_viridis_d(option = \"G\", begin = 0.4, direction = -1) +\n    lims(x = c(300, 850)) +\n    labs(x = \"Notas\", y = \"Renda\") +\n    theme_darkly +\n    theme_ridges\n\n\n\n\nestado civil cor nacionalidade situação_médio"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "ENEM",
    "section": "",
    "text": "Início\nkek"
  },
  {
    "objectID": "chapters/3-modelagem.html",
    "href": "chapters/3-modelagem.html",
    "title": "\n3  Modelagem\n",
    "section": "",
    "text": "library(tidyverse)\nlibrary(tidymodels)\nsource(\"../misc/themes.R\")\n\n\nmicrodados <- \"../dados/microdados0.parquet\" |>\n    arrow::read_parquet()\n\n\nset.seed(0)\nmicrodados_split <- initial_split(microdados, prop = 3/4)\nmicrodados_train <- training(microdados_split)\nmicrodados_test  <-  testing(microdados_split)\nmicrodados_fold  <- vfold_cv(microdados_train, v = 5)\n\n\nmicrodados_model <- linear_reg(\n    penalty = tune(), mixture = tune()\n) |>\n    set_engine(\"glmnet\") |>\n    set_mode(\"regression\")\n\nmicrodados_recipe <- microdados_train |> \n    recipe(LC ~ .) |> \n    update_role(R, inscrição, região, município, new_role = \"id\") |> \n    step_unknown(estado_civil, cor, nacionalidade) |> \n    step_dummy(all_nominal_predictors()) \n\nmicrodados_workflow <- workflow() |> \n    add_model(microdados_model) |> \n    add_recipe(microdados_recipe)\n\n\nmicrodados_grid <- microdados_workflow |> \n    extract_parameter_set_dials() |> \n    grid_regular(levels = 6)\n\nmicrodados_tune <- microdados_workflow |> \n    tune_grid(microdados_fold, grid = microdados_grid)\n\n\nmicrodados_tune |> \n    unnest(.metrics) |> \n    group_by(.metric, penalty, mixture) |> \n    summarise(.estimate = mean(.estimate)) |> \n    ggplot(aes(x = penalty, y = .estimate)) +\n    geom_line(aes(color = mixture, group = mixture)) +\n    facet_grid(vars(.metric), switch = \"y\", scales = \"free\") +\n    scale_x_log10() +\n    scale_color_viridis_c(\n        guide = guide_colorbar(ticks = FALSE)\n    ) +\n    theme_darkly\n\n\n\nmicrodados_best <- microdados_tune |> \n    select_by_one_std_err(desc(penalty), metric = \"rmse\")\n\n\nmicrodados_workflow_final <- microdados_workflow |> \n    finalize_workflow(microdados_best)\n\nmicrodados_fit_final <- microdados_workflow_final |> \n    last_fit(microdados_split)\n\n\nmicrodados_fit_final |> \n    collect_predictions() |> \n    head(10000) |> \n    mutate(diff = abs(LC - .pred)) |> \n    ggplot(aes(x = LC, y = .pred, color = diff)) +\n    geom_point(size = 0.01) +\n    geom_abline(linetype = 5, color = \"#ffffff\") +\n    scale_color_viridis_c(\n        option = \"G\", begin = 0.3,\n        guide = guide_colorbar(ticks = FALSE)\n    ) +\n    coord_obs_pred() +\n    theme_darkly\n\n\n\nmicrodados_fit_final |> \n    collect_metrics()\n\n# A tibble: 2 × 4\n  .metric .estimator .estimate .config             \n  <chr>   <chr>          <dbl> <chr>               \n1 rmse    standard      45.4   Preprocessor1_Model1\n2 rsq     standard       0.650 Preprocessor1_Model1"
  }
]